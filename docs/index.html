<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYDRA</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/nkn-sdk@1.3.6/dist/nkn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/",
                "nats.ws": "https://cdn.jsdelivr.net/npm/nats.ws@1.29.2/esm/nats.js",
                "@xenova/transformers": "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js",
                "onnxruntime-web": "https://cdn.jsdelivr.net/npm/onnxruntime-web@1.23.2/dist/ort.min.mjs",
                "phonemizer": "https://cdn.jsdelivr.net/npm/phonemizer@1.2.1/+esm"
            }
        }
    </script>
    <script>
        window.__hydraWasm = {
            ortWasmPath: 'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.23.2/dist/',
            defaultWasmThreads: 1
        };
    </script>
</head>

<body>
    <main>

        <!-- GRAPH WORKSPACE -->
        <section class="span-12" id="graphCard">
            <div id="workspaceWrap" class="">
                <div class="menu-row">
                    <div class="node-row">
                        <div class="node-menu">
                            <button id="nodeMenuToggle" class="secondary"><img class="icon" src="img/plus.svg"
                                    alt=""></button>
                            <div id="nodeMenuList" class="node-menu-list hidden"></div>
                        </div>
                        <button id="flowsButton" class="ghost"><img src="img/layer.svg" alt=""
                                class="icon inverted"></button>
                        <button id="peerListButton" class="ghost">
                            <img src="img/network.svg" alt="" class="icon inverted">
                            <span id="peerOnlineBadge" class="peer-badge hidden">0</span>
                            <span id="noclipPeerBadge" class="noclip-peer-badge hidden">0</span>
                        </button>
                        <button id="syncQrButton" class="ghost"><img src="img/qr.svg" alt=""
                                class="icon inverted"></button>
                    </div>
                    <div class="header-actions">
                        <a class="router-download" href="/router.py" download="router.py">
                            <button><img src="img/code.svg" alt="" class="icon"></button>
                        </a>
                        <button id="transportToggle" class="transport-btn">NKN</button>
                    </div>
                </div>
                <svg id="linksSvg" width="100%" height="100%" preserveAspectRatio="none"></svg>
                <div id="workspace">
                    <div id="wsCanvas" class="dot-bg"></div>
                </div>
                <div class="logdata" id="logdata">
                    <div class="log-controls">
                        <button type="button" id="logToggleBtn" class="ghost"><img src="img/chevron-down.svg" alt=""
                                class="icon inverted"></button>
                        <div class="history-buttons">
                            <button type="button" id="undoBtn" class="ghost" disabled><img
                                    src="img/chevron-left-double.svg" alt="" class="icon inverted"></button>
                            <button type="button" id="redoBtn" class="ghost" disabled><img
                                    src="img/chevron-right-double.svg" alt="" class="icon inverted"></button>
                        </div>
                    </div>
                    <div class="log-panels" id="logPanels">
                        <div id="wiresBox" class="code" style="min-height:54px;"></div>
                        <div id="logBox" class="code" style="min-height:120px;">(logs)</div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- SETTINGS MODAL (dynamic contents) -->
    <div id="settingsModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="closeBackdrop"></div>
        <div class="modal-panel">
            <div class="modal-head">
                <div class="modal-title">Node Settings</div>
                <button class="ghost" id="closeSettings">✕</button>
            </div>
            <form id="settingsForm">
                <div id="settingsFields" class="form-grid"></div>
                <div class="help" id="settingsHelp" style="margin-top:6px;">—</div>
                <div class="row" style="margin-top:12px;">
                    <button id="saveSettings">Save to Node</button>
                    <button class="ghost" id="cancelSettings" type="button">Close</button>
                </div>
            </form>
        </div>
    </div>

    <div id="docsModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="docsBackdrop"></div>
        <div class="modal-panel docs-panel">
            <div class="modal-head">
                <div class="modal-title">HYDRA DOCS</div>
                <div class="docs-head-actions">
                    <input id="docsSearch" type="search" placeholder="Search nodes…" aria-label="Search docs" />
                    <button class="ghost" id="docsClose">✕</button>
                </div>
            </div>
            <div class="docs-body">
                <aside class="docs-sidebar" id="docsSidebar"></aside>
                <article class="docs-content">
                    <div id="docsContent">(loading…)</div>
                    <div class="docs-actions">
                        <button class="secondary" id="docsInsertBtn" data-node-type="">Insert node into graph</button>
                    </div>
                </article>
            </div>
        </div>
    </div>

    <div id="flowsModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="flowsBackdrop"></div>
        <div class="modal-panel" style="max-width:600px;">
            <div class="modal-head">
                <div class="modal-title" data-flows-title>Flows</div>
                <button class="ghost" id="flowsClose">✕</button>
            </div>
            <div class="modal-body" id="flowsBody"></div>
        </div>
    </div>

    <div id="qrModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="qrBackdrop"></div>
        <div class="modal-panel" style="max-width:420px;">
            <div class="modal-head">
                <div class="modal-title">Scan NKN Address</div>
                <button class="ghost" id="qrClose">✕</button>
            </div>
            <div class="qr-body">
                <video id="qrVideo" autoplay playsinline muted></video>
                <canvas id="qrCanvas" width="0" height="0"></canvas>
                <div class="help">Align the QR code within the frame. The scanned value will populate the field
                    automatically.</div>
                <button class="ghost" type="button" id="qrStop">Cancel</button>
            </div>
        </div>
    </div>

    <div id="nknDmInviteModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="nknDmInviteBackdrop"></div>
        <div class="modal-panel" style="max-width:360px;">
            <div class="modal-head">
                <div class="modal-title">NKN Connection Request</div>
                <button class="ghost" id="nknDmInviteClose">✕</button>
            </div>
            <div class="modal-body">
                <div class="help" data-nkndm-invite-text>—</div>
                <div class="row" style="margin-top:12px;">
                    <button id="nknDmInviteAccept" class="secondary">Accept</button>
                    <button id="nknDmInviteDecline" class="ghost">Decline</button>
                </div>
            </div>
        </div>
    </div>

    <div id="mediaInviteModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="mediaInviteBackdrop"></div>
        <div class="modal-panel" style="max-width:360px;">
            <div class="modal-head">
                <div class="modal-title">Media Stream Request</div>
                <button class="ghost" id="mediaInviteClose">✕</button>
            </div>
            <div class="modal-body">
                <div class="help" data-media-invite-text>—</div>
                <div class="row" style="margin-top:12px;">
                    <button id="mediaInviteAccept" class="secondary">Accept</button>
                    <button id="mediaInviteDecline" class="ghost">Decline</button>
                </div>
            </div>
        </div>
    </div>

    <div id="syncQrModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="syncQrBackdrop"></div>
        <div class="modal-panel" style="max-width:380px;">
            <div class="modal-head">
                <div class="modal-title">Workspace Share QR</div>
                <button class="ghost" id="syncQrClose">✕</button>
            </div>
            <div class="modal-body" style="display:flex;flex-direction:column;align-items:center;gap:16px;">
                <canvas id="syncQrCanvas" width="0" height="0"></canvas>
                <div class="help" id="syncQrHelp" style="text-align:center;max-width:320px;">
                    Scan this code on another device to fetch their workspace.
                </div>
                <div class="muted" id="syncQrLink" style="word-break:break-all;text-align:center;"></div>
            </div>
        </div>
    </div>

    <div id="syncShareModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="syncShareBackdrop"></div>
        <div class="modal-panel" style="max-width:360px;">
            <div class="modal-head">
                <div class="modal-title">Share Workspace</div>
                <button class="ghost" id="syncShareClose">✕</button>
            </div>
            <div class="modal-body">
                <div class="help" id="syncShareMessage">—</div>
                <div class="row" style="margin-top:16px;gap:8px;flex-wrap:wrap;">
                    <button id="syncShareYes" class="secondary">Share My Graph</button>
                    <button id="syncShareRequest" class="ghost">Request Their Graph</button>
                    <button id="syncShareNo" class="ghost">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="syncReceiveModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="syncReceiveBackdrop"></div>
        <div class="modal-panel" style="max-width:360px;">
            <div class="modal-head">
                <div class="modal-title">Incoming Workspace</div>
                <button class="ghost" id="syncReceiveClose">✕</button>
            </div>
            <div class="modal-body">
                <div class="help" id="syncReceiveMessage">—</div>
                <div class="row" style="margin-top:16px;">
                    <button id="syncReceiveYes" class="secondary">Accept</button>
                    <button id="syncReceiveNo" class="ghost">Decline</button>
                </div>
            </div>
        </div>
    </div>

    <div id="peerModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="peerBackdrop"></div>
        <div class="modal-panel" style="max-width:720px;">
            <div class="modal-head">
                <div class="modal-title">Discovered Peers</div>
                <button class="ghost" id="peerClose">✕</button>
            </div>
            <div class="modal-body peer-modal-body two-col" id="peerModalBody">
                <div class="peer-tabs" id="peerTabs">
                    <button type="button" class="peer-tab active" data-pane="list">Peers</button>
                    <button type="button" class="peer-tab" data-pane="chat">Chat</button>
                </div>
                <div class="peer-left">
                    <div class="help" id="peerStatus">Initializing discovery...</div>
                    <div class="peer-identity">
                        <label for="peerUsernameInput">Display Name</label>
                        <div class="peer-identity-row">
                            <input id="peerUsernameInput" type="text" placeholder="Set a short username" maxlength="48"
                                autocomplete="off" spellcheck="false">
                            <button type="button" class="secondary" id="peerUsernameApply">Save</button>
                        </div>
                        <div class="peer-self muted" id="peerSelf"></div>
                        <div class="peer-self-name muted" id="peerSelfName"></div>
                    </div>
                    <div class="peer-filters">
                        <div class="peer-network-tabs" id="peerNetworkTabs">
                            <button type="button" class="ghost active" data-network="hydra">Hydra</button>
                            <button type="button" class="ghost" data-network="noclip">NoClip</button>
                        </div>
                        <input id="peerSearchInput" type="text" placeholder="Search peers" autocomplete="off"
                            spellcheck="false">
                        <button type="button" class="ghost" id="peerFavoritesToggle" title="Show favorites only">☆</button>
                    </div>
                    <div class="peer-list" id="peerList"></div>
                </div>

                <div class="peer-right" id="chatWrap">
                    <div class="chat-header">
                        <div id="chatPeerName">Select a peer…</div>
                        <button type="button" class="ghost" id="chatFavoriteBtn" title="Toggle favorite">☆</button>
                    </div>
                    <div class="chat-status muted" id="chatStatus">—</div>
                    <div class="chat-messages" id="chatMessages" aria-live="polite"></div>
                    <div class="chat-typing muted hidden" id="chatTyping">typing…</div>
                    <div class="chat-input">
                        <input id="chatInput" type="text" placeholder="Type a message" autocomplete="off" disabled>
                        <button id="chatSend" class="secondary" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="graphDropModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="graphDropBackdrop"></div>
        <div class="modal-panel" style="max-width:360px;">
            <div class="modal-head">
                <div class="modal-title">Graph Detected</div>
                <button class="ghost" id="graphDropClose">✕</button>
            </div>
            <div class="modal-body">
                <div class="help" id="graphDropMessage">Graph detected, load into editor?</div>
                <div class="row" style="margin-top:16px;gap:8px;flex-wrap:wrap;">
                    <button id="graphDropLoad" class="secondary">Yes</button>
                    <button id="graphDropNo" class="ghost">No</button>
                    <button id="graphDropSave" class="ghost">Save to node list</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        (() => {
            if (window.__hydraTitleStatusPatch) return;
            window.__hydraTitleStatusPatch = true;

            const BASE_TITLE = document.title;

            const statusEmoji = (cls) => {
                if (!cls) return '⚪️';
                if (cls.includes('err')) return '⛔';
                if (cls.includes('warn')) return '⚠️';
                if (cls.includes('ok')) return '✅';
                return '⚪️';
            };

            const getDotSpan = () => {
                const toggle = document.getElementById('transportToggle');
                if (!toggle) return null;
                // Prefer an explicit .dot span; otherwise fall back to first span
                return toggle.querySelector('span.dot') || toggle.querySelector('span') || null;
            };

            const getStatus = () => {
                const dot = getDotSpan();
                const cls = dot ? (dot.className || '') : '';
                return statusEmoji(cls);
            };

            const getOnlineCount = () => {
                const badge = document.getElementById('peerOnlineBadge');
                if (!badge) return 0;
                const txt = (badge.textContent || '').trim();
                const n = parseInt(txt, 10);
                return Number.isFinite(n) ? n : 0;
            };

            const applyTitle = () => {
                const emoji = getStatus();
                const count = getOnlineCount();
                document.title = `${emoji} | ${count} | ${BASE_TITLE}`;
            };

            // Attach observers once elements exist
            const tryAttachObservers = () => {
                const toggle = document.getElementById('transportToggle');
                const badge = document.getElementById('peerOnlineBadge');

                let attached = false;

                if (toggle) {
                    // Watch for class/text changes anywhere under the toggle (including the dot span)
                    const obsToggle = new MutationObserver(applyTitle);
                    obsToggle.observe(toggle, {
                        subtree: true,
                        attributes: true,
                        attributeFilter: ['class'],
                        childList: true,
                        characterData: true
                    });
                    attached = true;
                }

                if (badge) {
                    // Watch for number changes inside the badge
                    const obsBadge = new MutationObserver(applyTitle);
                    obsBadge.observe(badge, {
                        subtree: true,
                        childList: true,
                        characterData: true
                    });
                    attached = true;
                }

                if (attached) applyTitle();
                return attached;
            };

            const onReady = () => {
                if (tryAttachObservers()) return;
                // If elements aren’t there yet, watch for them to appear
                const rootObs = new MutationObserver(() => {
                    if (tryAttachObservers()) rootObs.disconnect();
                });
                rootObs.observe(document.documentElement, { subtree: true, childList: true });
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', onReady);
            } else {
                onReady();
            }

            // Light safety net in case something mutates without firing observers
            setInterval(applyTitle, 3000);
        })();
    </script>

    <script type="module">
        import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.4/+esm";
        window.QRCode = QRCode;
    </script>
    <script>
        (function ensureQR() {
            if (window.QRCode && typeof window.QRCode.toCanvas === 'function') return;
            var s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js';
            document.head.appendChild(s);
        })();
    </script>
    <script type="module" src="js/main.js"></script>
</body>

</html>
